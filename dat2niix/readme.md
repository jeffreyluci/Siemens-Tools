# dat2niix

**dat2niix** - A MATLAB function that generates multi-echo NIfTI files from raw image (pixel)
           data saved by WashU's NORDIC functor from the CMRR BOLD EPI pulse sequence.

# Usage:
`dat2niix(dicomDirectory, datDirectory, niftiDirectory)`, or optionally,
  `dat2niix(dicomDirectory, datDirectory, niftiDirectory, options)`

**dicomDirectory**: The full path to a directory that contains the DICOM of
                the first echo. If magnitude and phase data are saved,
                each must be saved in individual and separate directories.

**datDirectory**: The full path to a directory of all the raw image (*.dat)
              files generated by the NORDIC functor. These dat files need
              not be separated into different directories for each series
              or for magnitude & phase data. Everything can exist in one
              location, which is how they are saved on the scanner.

**niftiDirectory**: The full path to the directory that will contain the new
                NIfTI files. It is recomended that this folder be empty to
                avoid confusion, but that is not required.

**Options**:

`Verbose = true/(false)` - verbose output to the command line

`highPrecision = true/(false)` - TE recorded in headers with 
                         microsecond precision when set to true, otherwise
                         the TE is recorded with (more common) tenth of a
                         millisecond precision

`reportTime = true/(false)` - report the total time spent processing the job

`logFile = <log file location>` - A text file will be created at the 
                                  location of the log file specified at the 
                                  verbosity level specified. Note that this 
                                  file will be sparsely populated or even 
                                  empty for successful jobs with the Verbose
                                  option turned off. The default is no
                                  logging.

`fileRange = [first, last]` - A 2x1 matrix with the elements denoting the first and
                     last repetitions (volumes) to be included in a run.
                     This option is provided in order to process runs that
                     were ended prematurely or that has data missing for
                     whatever reason. Only the volumes in the range
                     requested will beincluded int he resulting NIfTIs.

 # Discussion:
 
 This function works in conjunction with both the CMRR multiband BOLD EPI 
 sequence and the WashU NORDIC recon functor to produce multi-echo, 
 compressed NIfTIs assembled from the raw image data saved on the scanner
 and header information gathered from both the DICOM of the first echo and
 the NIfTI generated by dcm2niix.

 This solution is meant to avoid resource spikes on the scanner host due
 to what is suspected to be lack of full support of multi-echo images from
 the CMRR BOLD EPI sequence. The NORDIC functor writes only the first echo
 to the host's database and routes the raw images data to a temporary
 location on the scanner's local drive. The raw images do not have any
 metadata associated with them, so dcm2niix is used to generate the first
 echo's header from the DICOM. This function uses the DICOM and the NIfTI
 from dcm2niix to assemble NIfTIs of all echos, one file per echo. 

 The multi-echo NIfTI headers contain the correct TE for their respecitve
 data and the slice timing parameters for all but the first echo have their
 respective TEs added to them. It is possible to force maximum precision
 recording of the TEs with the highPrecision logical argument.

 Two dependencies exist for this function. The package dcm2niix is
 maintained and distributed at [Chris Rorden's GitHub.](https://github.com/rordenlab/dcm2niix)
 The M-file parseMrProt.m is maintained and distributed at [Jeff Luci's GitHub.](https://github.com/jeffreyluci/Siemens-Tools/tree/main/parseMrProt)
 All software called by or otherwise used by this M-file is subject to the
 license and citation requirements described on their respective GitHub pages.

 The NORDIC reconstruction functor (pipeline) is available at [The Siemens Teamplay C<sup>2</sup>P Exchange.](https://webclient.us.api.teamplay.siemens-healthineers.com/c2p)

 # Acknowledgements
 Cihat Eldeniz provided invaluable tips and advice on proper implementation of NORDIC, troubleshooting issues, and editing this text.
 
 Chris Markiewicz, Chris Rorden, and Russ Poldrak provided valuable feedback regarding best practices for maintaining good data provenance records in the json sidecars. 

 @github.com/glasserm contributed support for SBRef images and identified an image orientation bug fixed in v20240221.

# Version History
20240201:  Initial Release.

20240202:  Added timed option and numerous comment improvements.

20240206:  Added provenance notation in json sidecar to ConversionSoftware 
           and ConversionSoftwareVersion objects. Fixed time report bug.

20240219: Added logging feature. Changed NIfTI naming convention to make
          it more BIDS-firendly. Added more verbose-level descriptive
		  text.

20240220: Added log filename automatic incrementing feature. Fixed bug
          that prevented execution time from being written to log.
          Corrected the logged filenames for the NIfTIs written to
          include the full path name.
		  
20240221: Added support for SBRef image type (contributed). Fixed image
          orientation bug (contributed). Fixed timed option bug that
          minifested without verbose output (contributed). Made json
          filename consistent (contributed). Fixed json file extention.
          Added start and end timestamps with version logging. Improved
          log file incrementing function flow.
		  
20240403: Added EchoNumber to json files to improve workability with 
          fmriprep and for consistency.
		  
20241010: Fixed incorrect conversion of echo time and slice timing from
          microseconds to seconds. Factor incorrectly used was 10e6,
          changed to 1e6. Also updated systematic shift in slice timing.

20250505: Added fileRange option and created dcm2niixInfo object in JSON
          sidecar to be consistent with other third party info logging.

20250602: Added feature to automatically detect a manually-stopped scan
          and process only the available number of images. Optimized the
          declaration and allocation of memory for the workList, which
          resulted in about a 6% speed improvement.
